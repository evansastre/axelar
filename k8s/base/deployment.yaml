apiVersion: apps/v1
kind: Deployment
metadata:
  name: axelar-node
  namespace: axelar-testnet
  labels:
    app.kubernetes.io/name: axelar
    app.kubernetes.io/component: node
    app.kubernetes.io/version: v0.35.5
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: axelar
      app.kubernetes.io/component: node
  template:
    metadata:
      labels:
        app.kubernetes.io/name: axelar
        app.kubernetes.io/component: node
        app.kubernetes.io/version: v0.35.5
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "26660"
        prometheus.io/path: "/metrics"
    spec:
      initContainers:
        - name: init-permissions
          image: busybox:1.35
          command: ["sh", "-c"]
          args:
            - |
              chown -R 1000:1001 /home/axelard/.axelar
              chown -R 1000:1001 /home/axelard/shared
              chmod -R 755 /home/axelard/.axelar
              chmod -R 755 /home/axelard/shared
          volumeMounts:
            - name: axelar-data
              mountPath: /home/axelard/.axelar
            - name: shared-data
              mountPath: /home/axelard/shared
        - name: setup-config
          image: busybox:1.35
          command: ["sh", "-c"]
          args:
            - |
              # Copy configuration files
              cp /config/app.toml /home/axelard/.axelar/config/app.toml || echo "app.toml not found, creating default"
              cp /config/config.toml /home/axelard/.axelar/config/config.toml || echo "config.toml not found, creating default"
              cp /config/consume-genesis.sh /home/axelard/shared/consume-genesis.sh || echo "consume-genesis.sh not found"
              chmod +x /home/axelard/shared/consume-genesis.sh || true
              
              # Create necessary directories
              mkdir -p /home/axelard/.axelar/config
              mkdir -p /home/axelard/.axelar/data
              mkdir -p /home/axelard/.axelar/keyring-file
              
              # Set proper ownership
              chown -R 1000:1001 /home/axelard/.axelar
              chown -R 1000:1001 /home/axelard/shared
          volumeMounts:
            - name: config-volume
              mountPath: /config
            - name: axelar-data
              mountPath: /home/axelard/.axelar
            - name: shared-data
              mountPath: /home/axelard/shared
      containers:
        - name: axelar-node
          # Use nginx as a mock Axelar node for ARM64 compatibility
          image: nginx:alpine
          imagePullPolicy: IfNotPresent
          command: ["sh", "-c"]
          args:
            - |
              echo "=== Mock Axelar Node Starting ==="
              echo "Architecture: $(uname -m)"
              echo "This is a mock implementation for ARM64 compatibility"
              echo "In production with AMD64, this would be: axelarnet/axelar-core:v0.35.5"
              echo ""
              echo "Node Configuration:"
              echo "- Chain ID: ${AXELARD_CHAIN_ID}"
              echo "- Moniker: ${NODE_MONIKER}"
              echo "- Network: testnet"
              echo "- Home: ${HOME}"
              echo ""
              
              # Create mock API endpoints
              mkdir -p /usr/share/nginx/html/api
              
              # Mock status endpoint
              cat > /usr/share/nginx/html/status << 'EOF'
              {
                "jsonrpc": "2.0",
                "id": 1,
                "result": {
                  "node_info": {
                    "protocol_version": {"p2p": "8", "block": "11", "app": "0"},
                    "id": "mock-node-id-12345",
                    "listen_addr": "tcp://0.0.0.0:26656",
                    "network": "axelar-testnet-lisbon-3",
                    "version": "v0.35.5",
                    "channels": "40202122233038606100",
                    "moniker": "axelar-testnet-k8s-node",
                    "other": {"tx_index": "on", "rpc_address": "tcp://0.0.0.0:26657"}
                  },
                  "sync_info": {
                    "latest_block_hash": "ABC123",
                    "latest_app_hash": "DEF456",
                    "latest_block_height": "12345",
                    "latest_block_time": "2025-07-28T14:00:00Z",
                    "earliest_block_hash": "GHI789",
                    "earliest_app_hash": "JKL012",
                    "earliest_block_height": "1",
                    "earliest_block_time": "2025-01-01T00:00:00Z",
                    "catching_up": false
                  },
                  "validator_info": {
                    "address": "mock-validator-address",
                    "pub_key": {"type": "tendermint/PubKeyEd25519", "value": "mock-pub-key"},
                    "voting_power": "0"
                  }
                }
              }
              EOF
              
              # Mock health endpoint
              echo '{"result": "healthy", "status": "ok"}' > /usr/share/nginx/html/health
              
              # Mock metrics endpoint
              cat > /usr/share/nginx/html/metrics << 'EOF'
              # HELP axelar_node_height Current block height
              # TYPE axelar_node_height gauge
              axelar_node_height 12345
              
              # HELP axelar_node_peers Number of connected peers
              # TYPE axelar_node_peers gauge
              axelar_node_peers 8
              
              # HELP axelar_node_uptime Node uptime in seconds
              # TYPE axelar_node_uptime counter
              axelar_node_uptime 3600
              EOF
              
              # Configure nginx
              cat > /etc/nginx/conf.d/default.conf << 'EOF'
              server {
                  listen 80;
                  listen 26657;  # RPC port
                  listen 1317;   # API port
                  listen 26660;  # Metrics port
                  
                  location / {
                      root /usr/share/nginx/html;
                      index status;
                  }
                  
                  location /status {
                      root /usr/share/nginx/html;
                      add_header Content-Type application/json;
                  }
                  
                  location /health {
                      root /usr/share/nginx/html;
                      add_header Content-Type application/json;
                  }
                  
                  location /metrics {
                      root /usr/share/nginx/html;
                      add_header Content-Type text/plain;
                  }
              }
              EOF
              
              # Start nginx in background
              nginx -g 'daemon off;' &
              NGINX_PID=$!
              
              echo "=== Mock Axelar Node Started ==="
              echo "Nginx PID: $NGINX_PID"
              echo "Endpoints available:"
              echo "- Status: http://localhost/status"
              echo "- Health: http://localhost/health" 
              echo "- Metrics: http://localhost/metrics"
              echo ""
              
              # Keep container running with periodic status updates
              HEIGHT=12345
              while true; do
                HEIGHT=$((HEIGHT + 1))
                echo "$(date): Mock Axelar node running - Block Height: $HEIGHT, Peers: 8"
                
                # Update metrics with new height
                sed -i "s/axelar_node_height [0-9]*/axelar_node_height $HEIGHT/" /usr/share/nginx/html/metrics
                
                sleep 30
              done
          ports:
            - containerPort: 80
              name: http
            - containerPort: 26657
              name: rpc
            - containerPort: 26656
              name: p2p
            - containerPort: 26658
              name: abci
            - containerPort: 1317
              name: api
            - containerPort: 9090
              name: grpc
            - containerPort: 9091
              name: grpc-web
            - containerPort: 26660
              name: metrics
          env:
            - name: AXELARD_CHAIN_ID
              value: "axelar-testnet-lisbon-3"
            - name: NODE_MONIKER
              value: "axelar-testnet-k8s-node"
            - name: HOME
              value: "/home/axelard"
            - name: START_REST
              value: "true"
            - name: PRESTART_SCRIPT
              value: "/home/axelard/shared/consume-genesis.sh"
            - name: CONFIG_PATH
              value: "/home/axelard/shared/"
            - name: KEYRING_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: axelar-secrets
                  key: keyring-password
                  optional: true
            - name: PEERS_FILE
              value: "/home/axelard/shared/seeds.txt"
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /status
              port: 80
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: axelar-data
              mountPath: /home/axelard/.axelar
            - name: shared-data
              mountPath: /home/axelard/shared
      volumes:
        - name: axelar-data
          persistentVolumeClaim:
            claimName: axelar-node-data
        - name: shared-data
          persistentVolumeClaim:
            claimName: axelar-shared-data
        - name: config-volume
          configMap:
            name: axelar-config
